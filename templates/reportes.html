{% extends "base.html" %}

{% block title %}Reportes{% endblock %}

{% block content %}
<style>
    /* Estilos personalizados para las pestañas de reportes */
    .nav-tabs {
        border-bottom: 2px solid #667eea;
    }
    
    .nav-tabs .nav-link {
        color: #000000 !important;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-bottom: none;
        margin-right: 5px;
        border-radius: 8px 8px 0 0;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .nav-tabs .nav-link:hover {
        color: #000000 !important;
        background-color: #e9ecef;
        border-color: #667eea;
    }
    
    .nav-tabs .nav-link.active {
        color: #000000 !important;
        background-color: #ffffff;
        border-color: #667eea #667eea transparent;
        font-weight: 600;
        border-bottom: 2px solid white;
    }
    
    .nav-tabs .nav-link.active:hover {
        color: #000000 !important;
        background-color: #ffffff;
    }
    
    /* Forzar color negro en todos los estados */
    #reportTabs .nav-link,
    #reportTabs .nav-link:focus,
    #reportTabs .nav-link:hover,
    #reportTabs .nav-link.active,
    #reportTabs .nav-link.active:focus,
    #reportTabs .nav-link.active:hover {
        color: #000000 !important;
    }
</style>

<h1 class="mb-4"><i class="bi bi-graph-up"></i> Reportes del Sistema</h1>

<!-- Navegación por pestañas -->
<ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="alquileres-cliente-tab" data-bs-toggle="tab" 
                data-bs-target="#alquileres-cliente" type="button" role="tab">
            Alquileres por Cliente
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="vehiculos-tab" data-bs-toggle="tab" 
                data-bs-target="#vehiculos" type="button" role="tab">
            Vehículos Más Alquilados
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="facturacion-tab" data-bs-toggle="tab" 
                data-bs-target="#facturacion" type="button" role="tab">
            Facturación Mensual
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="exportar-csv-tab" data-bs-toggle="tab" 
                data-bs-target="#exportar-csv" type="button" role="tab">
            Exportar Lista Alquileres (CSV)
        </button>
    </li>
</ul>

<!-- Contenido de las pestañas -->
<div class="tab-content" id="reportTabsContent">
    <!-- Pestaña: Alquileres por Cliente -->
    <div class="tab-pane fade show active" id="alquileres-cliente" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Listado de Alquileres por Cliente</h5>
            </div>
            <div class="card-body">
                <div id="alquileres-cliente-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pestaña: Vehículos Más Alquilados -->
    <div class="tab-pane fade" id="vehiculos" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Vehículos Más Alquilados</h5>
            </div>
            <div class="card-body">
                <div id="vehiculos-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pestaña: Facturación Mensual -->
    <div class="tab-pane fade" id="facturacion" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Facturación Mensual - Gráfico de Barras</h5>
            </div>
            <div class="card-body">
                <div id="facturacion-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pestaña: Exportar Lista Alquileres (CSV) -->
    <div class="tab-pane fade" id="exportar-csv" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Exportar Lista de Alquileres a CSV</h5>
            </div>
            <div class="card-body">
                <div id="exportar-csv-content">
                    <p class="mb-3">Haga clic en el botón para descargar la lista completa de alquileres en formato CSV.</p>
                    <a href="/api/reportes/exportar-alquileres-csv" class="btn btn-primary">
                        <i class="bi bi-file-earmark-arrow-down"></i> Descargar CSV
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Cargar alquileres por cliente
function cargarAlquileresPorCliente() {
    fetch('/api/reportes/alquileres-por-cliente')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('alquileres-cliente-content');
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay datos disponibles.</p>';
                return;
            }
            
            let html = '<table class="table table-striped table-hover"><thead><tr>' +
                '<th>Cliente</th><th>Total Alquileres</th><th>Total Facturado</th><th>Acciones</th>' +
                '</tr></thead><tbody>';
            
            data.forEach(item => {
                html += `<tr>
                    <td>${item.cliente_nombre || 'Sin nombre'}</td>
                    <td>${item.total_alquileres || 0}</td>
                    <td>$${parseFloat(item.total_facturado || 0).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="verDetalleCliente(${item.id_cliente}, '${item.cliente_nombre}')">
                            Ver Detalle
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        })
        .catch(error => {
            document.getElementById('alquileres-cliente-content').innerHTML = 
                '<div class="alert alert-danger">Error al cargar los datos.</div>';
        });
}

// Ver detalle de alquileres de un cliente
function verDetalleCliente(idCliente, nombreCliente) {
    fetch(`/api/reportes/detalle-alquileres-cliente/${idCliente}`)
        .then(response => response.json())
        .then(data => {
            let html = `<h6>Detalle de Alquileres - ${nombreCliente}</h6>`;
            if (data.length === 0) {
                html += '<p class="text-muted">Este cliente no tiene alquileres registrados.</p>';
            } else {
                html += '<table class="table table-sm table-bordered"><thead><tr>' +
                    '<th>ID</th><th>Fecha Inicio</th><th>Fecha Fin</th><th>Vehículo</th><th>Costo</th><th>Empleado</th>' +
                    '</tr></thead><tbody>';
                
                data.forEach(item => {
                    html += `<tr>
                        <td>${item.id_alquiler}</td>
                        <td>${item.fecha_inicio}</td>
                        <td>${item.fecha_fin}</td>
                        <td>${item.vehiculo || 'N/A'}</td>
                        <td>$${parseFloat(item.costo_total || 0).toFixed(2)}</td>
                        <td>${item.empleado || 'N/A'}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            // Mostrar en modal
            const modal = new bootstrap.Modal(document.getElementById('detalleModal'));
            document.getElementById('detalleModalBody').innerHTML = html;
            modal.show();
        });
}

// Cargar vehículos más alquilados
function cargarVehiculosMasAlquilados() {
    fetch('/api/reportes/vehiculos-mas-alquilados')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('vehiculos-content');
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay datos disponibles.</p>';
                return;
            }
            
            let html = '<table class="table table-striped table-hover"><thead><tr>' +
                '<th>Vehículo</th><th>Patente</th><th>Veces Alquilado</th><th>Total Facturado</th>' +
                '</tr></thead><tbody>';
            
            data.forEach(item => {
                html += `<tr>
                    <td>${item.descripcion || 'N/A'}</td>
                    <td>${item.patente || 'N/A'}</td>
                    <td>${item.veces_alquilado || 0}</td>
                    <td>$${parseFloat(item.total_facturado || 0).toFixed(2)}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        })
        .catch(error => {
            document.getElementById('vehiculos-content').innerHTML = 
                '<div class="alert alert-danger">Error al cargar los datos.</div>';
        });
}

// Cargar facturación mensual con gráfico
function cargarFacturacionMensual() {
    fetch('/api/reportes/facturacion-mensual-grafico')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('facturacion-content');
            if (data.imagen) {
                container.innerHTML = `<img src="data:image/png;base64,${data.imagen}" class="img-fluid" alt="Gráfico de Facturación Mensual">`;
            } else {
                container.innerHTML = '<div class="alert alert-warning">No se pudo generar el gráfico. Asegúrese de que matplotlib esté instalado.</div>';
            }
        })
        .catch(error => {
            document.getElementById('facturacion-content').innerHTML = 
                '<div class="alert alert-danger">Error al cargar el gráfico.</div>';
        });
}

// Cargar datos cuando se muestra cada pestaña
document.addEventListener('DOMContentLoaded', function() {
    // Cargar datos iniciales
    cargarAlquileresPorCliente();
    
    // Event listeners para las pestañas
    document.getElementById('alquileres-cliente-tab').addEventListener('shown.bs.tab', function() {
        cargarAlquileresPorCliente();
    });
    
    document.getElementById('vehiculos-tab').addEventListener('shown.bs.tab', function() {
        cargarVehiculosMasAlquilados();
    });
    
    document.getElementById('facturacion-tab').addEventListener('shown.bs.tab', function() {
        cargarFacturacionMensual();
    });
});
</script>

<!-- Modal para detalle de cliente -->
<div class="modal fade" id="detalleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Alquileres</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalleModalBody">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
